<h1> Customizing tokens and auth codes </h1>
[toc]
<h2>About customizing tokens and auth codes</h2>
<p>Apigee Edge generates and distributes OAuth access tokens, refresh tokens, and authorization codes to apps. Edge stores those tokens and codes and uses them to authorize consumer apps.&nbsp;</p>
<p>When Edge generates these OAuth artifacts, it also generates a profile that contains metadata related to the token or code. For example, the default access token profile contains name/value pairs that define expiration time, the associated app and developer, and so on.</p>
<p>The JSON representation of an Edge access token looks like the following:</p>
<pre>
{
  "issued_at" : "1372170159093",
  "application_name" : "ccd1803b-b557-4520-bd62-ddd3abf8e501",
  "scope" : "READ",
  "status" : "approved",
  "api_product_list" : "[FreeProduct]",
  "expires_in" : "3599",
  "developer.email" : "joe@weathersample.com",
  "organization_id" : "0",
  "refresh_token" : "82XMXgDyHTpFyXOaApj8C2AGIPnN2IZe",
  "client_id" : "deAVedE0W9Z9U35PAMaAJYphBJCGdrND",
  "access_token" : "shTUmeI1geSKin0TODcGLXBNe9vp",
  "organization_name" : "apifactory",
  "refresh_count" : "0"
}</pre>
<p>Sometimes its useful to add custom attributes to an access token. For example, you might wish to embed a department name, a customer ID, or, more technically, a session identifier.&nbsp;You can also get and set these custom attributes at runtime using policies (as explained below).&nbsp;</p>
<h2>Customizing tokens with the OAuthV2 policy</h2>
<p>You can configure custom token attributes directly in the OAuthV2 policy that generates the tokens or auth codes.&nbsp;</p>
<pre>
&lt;Attributes&gt; 
  &lt;Attribute name="attr_name1" ref="flow.variable" display="true|false"&gt;value1&lt;/Attribute&gt;
  &lt;Attribute name="attr_name2" ref="flow.variable" display="true|false"&gt;value2&lt;/Attribute&gt;
&lt;/Attributes&gt;</pre>
<p>Where <code>display</code> is set to&nbsp;<code>true</code>, custom attributes are returned in the response, where they may be viewable by the app end user.</p>
<p>Where <code>display</code> is set to&nbsp;<code>false</code>, custom attributes are stored in the data store, but are not returned in the response message.</p>
<p>For example, to add the User-Agent associated with the request to an access token:</p>
<pre>
&lt;OAuthV2 name="GenerateAccessToken"&gt;
  &lt;Operation&gt;GenerateAccessToken
  &lt;/Operation&gt;
  &lt;ExpiresIn&gt;1000&lt;/ExpiresIn&gt;
  &lt;GenerateResponse /&gt;
  &lt;SupportedGrantTypes&gt;
    &lt;GrantType&gt;client_credentials&lt;/GrantType&gt;
  &lt;/SupportedGrantTypes&gt;
  &lt;GrantType&gt;request.queryparam.grant_type&lt;/GrantType&gt;
  &lt;Attributes&gt; 
    &lt;Attribute name="user-agent" ref="request.header.user-agent" display="false"&gt;&lt;/Attribute&gt;
  &lt;/Attributes&gt;
&lt;/OAuthV2&gt;</pre>
<h2>Getting and setting custom attributes at runtime</h2>
<p>In some situations, you will need to update the profile of an access token at runtime while an API call is being processed on Apigee Edge. To help with this, Apigee provides policies for getting and setting token attributes. For more information, see <a href="http://docs.apigee.com/node/14901">http://docs.apigee.com/node/14901</a> and <a href="http://docs.apigee.com/node/14906">http://docs.apigee.com/node/14906</a>.&nbsp;Use these policies when you need tokens to be updated at runtime, such as at the time when the token or code is generated by Apigee Edge.</p>
<div>The AccessToken element value is set to the name of the variable where the access token can be located: either in the request message, or in some other variable where it might be populated by an ExtractVariables policy.</div>
<p>You can also use Edge APIs to manage a token's profile. See the API documentation for the <a href="http://docs.apigee.com/node/16826">http://docs.apigee.com/node/16826</a> method.</p>
<h2>Training video</h2>
<p>Apigee offers free online training for API developers. Simply register for&nbsp;<a href="http://academy.apigee.com">Foundational Training: Create and Manage APIs</a>. Custom access token attributes is covered in&nbsp;<strong>Part 6, Lessons 5</strong>&nbsp;of this Apigee Academy free course.&nbsp;</p>
