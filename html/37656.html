<h1> Operation and configuration reference for Edge Microgateway </h1>
<p style="text-align: right;"><em>Edge Microgateway v. 2.4.x</em></p>
<h2>Overview</h2>
<p>This topic discusses how to manage and configure Edge Microgateway, including monitoring, logging, and debugging.</p>
<h2><a id="Making configuration changes" name="Making configuration changes"></a>Making configuration changes</h2>
<p>The configuration files you need to know about include:</p>
<ul>
	<li>Default system configuration file</li>
	<li>Default config file for a newly initialized Edge Microgateway instance</li>
	<li>Dynamic configuration file for running instances</li>
</ul>
<p>This section discusses these files and what you need to know about changing them. For details about configuration file settings, see&nbsp;<a href="#Edge Microgateway configuration reference">Edge Microgateway configuration reference</a>.</p>
<h3>Default system configuration file</h3>
<p>When you install Edge Microgateway, a default system configuration file is placed here:</p>
<p><code><strong>[prefix]/lib/node_modules/config/default.yaml</strong></code></p>
<p>where&nbsp;<code>[prefix]</code>&nbsp;is the&nbsp;<code>npm</code>&nbsp;prefix directory. See&nbsp;<a href="https://docs.apigee.com/microgateway/v2.4.x/installing-edge-microgateway-v2.4.x#whereisedgemicrogatewayinstalled">Where is Edge Microgateway installed</a>.</p>
<p>If you change the system config file, you must reinitialize, reconfigure, and restart Edge Microgateway:</p>
<ol>
	<li>Call&nbsp;<code>edgemicro init</code></li>
	<li>Call&nbsp;<code>edgemicro configure [params]</code></li>
	<li>Call&nbsp;<code>edgemicro start [params]</code></li>
</ol>
<h3>Default config file for newly initialized Edge Microgateway instances</h3>
<p>When you run&nbsp;<code><strong>edgemicro init</strong></code>, the system config file (described above),<code>&nbsp;default.yaml</code>, is placed in this directory: ~<code>/.edgemicro</code></p>
<p>If you change the config file in ~<code>/.edgemicro</code>, you must reconfigure and restart Edge Microgateway:</p>
<ol>
	<li><code>edgemicro stop</code></li>
	<li><code>edgemicro configure</code>&nbsp;<code>[params]</code></li>
	<li><code>edgemicro start</code>&nbsp;<code>[params]</code></li>
</ol>
<h3>Dynamic configuration file for running instances</h3>
<p>When you run&nbsp;<code><strong>edgemicro configure [params]</strong></code>, a dynamic configuration file is created in ~<code>/.edgemicro</code>. The file is named according to this pattern:&nbsp;<code>[org]-[env]-config.yaml</code>, where&nbsp;<code>org</code>&nbsp;and&nbsp;<code>env</code>&nbsp;are your Apigee Edge organization and environment names. You can use this file to make configuration changes, and then reload them with zero-downtime. For example, if you add and configure a plugin, you can reload the configuration without incurring any downtime, as explained below.&nbsp;</p>
<p><strong>If Edge Microgateway is running (zero-downtime option):</strong></p>
<ol>
	<li>Reload the Edge Microgateway configuration:
		<pre>
<strong>edgemicro reload -o [org] -e [env] -k [key] -s [secret]</strong></pre>
		<p>Where:</p>
		<ul>
			<li><strong><code>org</code></strong>&nbsp;is your Edge organization name (you must be an org administrator).</li>
			<li><strong><code>env</code></strong>&nbsp;is an environment in your org (such as test or prod).</li>
			<li><code><strong>key</strong></code>&nbsp;is the key returned previously by the configure command.</li>
			<li><code><strong>secret</strong></code>&nbsp;is the key returned previously by the configure command.</li>
		</ul>
		<p><strong>Example</strong></p>
		<pre>
<strong>edgemicro reload -o docs -e test -k 701e70ee718ce6dc188016b3c39177d64a88754d615c74e1f78b6181d000723 -s 05c14356e42ed136b8dd35cf8a18531ff52d7299134677e30ef4e34ab0cc824</strong></pre>
	</li>
</ol>
<p><strong>If Edge Microgateway is stopped:</strong></p>
<ol>
	<li>Restart Edge Microgateway:
		<pre>
<strong>edgemicro start -o [org] -e [env] -k [key] -s [secret]</strong></pre>
		<p>Where:</p>
		<ul>
			<li><strong><code>org</code></strong>&nbsp;is your Edge organization name (you must be an org administrator).</li>
			<li><strong><code>env</code></strong>&nbsp;is an environment in your org (such as test or prod).</li>
			<li><code><strong>key</strong></code>&nbsp;is the key returned previously by the configure command.</li>
			<li><code><strong>secret</strong></code>&nbsp;is the key returned previously by the configure command.</li>
		</ul>
		<p><strong>Example</strong></p>
		<pre>
<strong>edgemicro start -o docs -e test -k 701e70ee718ce6dc188016b3c39177d64a88754d615c74e1f78b6181d000723 -s </strong><strong>05c14356e42ed136b8dd35cf8a18531ff52d7299134677e30ef4e34ab0cc824</strong></pre>
	</li>
</ol>
<p>Here is an example config file. For details about configuration file settings, see&nbsp;<a href="#Edge Microgateway configuration reference">Edge Microgateway configuration reference</a>.</p>
<pre>
edge_config:
  bootstrap: &gt;-
    https://edgemicroservices-us-east-1.apigee.net/edgemicro/bootstrap/organization/docs/environment/test
  jwt_public_key: 'https://docs-test.apigee.net/edgemicro-auth/publicKey'
  managementUri: 'https://api.enterprise.apigee.com'
  vaultName: microgateway
  authUri: 'https://%s-%s.apigee.net/edgemicro-auth'
  baseUri: &gt;-
    https://edgemicroservices.apigee.net/edgemicro/%s/organization/%s/environment/%s
  bootstrapMessage: Please copy the following property to the edge micro agent config
  keySecretMessage: The following credentials are required to start edge micro
  products: 'https://docs-test.apigee.net/edgemicro-auth/products'
edgemicro:
  port: 8000
  max_connections: 1000
  max_connections_hard: 5000
  config_change_poll_interval: 600
  logging:
    level: error
    dir: /var/tmp
    stats_log_interval: 60
    rotate_interval: 24
  plugins:
    sequence:
      - oauth
headers:
  x-forwarded-for: true
  x-forwarded-host: true
  x-request-id: true
  x-response-time: true
  via: true
oauth:
  allowNoAuthorization: false
  allowInvalidAuthorization: false
  verify_api_key_url: 'https://docs-test.apigee.net/edgemicro-auth/verifyApiKey'
analytics:
  uri: &gt;-
    https://edgemicroservices-us-east-1.apigee.net/edgemicro/axpublisher/organization/docs/environment/test</pre>
<h2>Setting environment variables</h2>
<p>The command-line interface commands that require values for your Edge organization and environment, and the key and secret needed for starting Edge Microgateway can be stored in these environment variables:</p>
<ul>
	<li><code>EDGEMICRO_ORG</code></li>
	<li><code>EDGEMICRO_ENV</code></li>
	<li><code>EDGEMICRO_KEY</code></li>
	<li><code>EDGEMICRO_SECRET</code></li>
</ul>
<p>Setting these variables is optional. If you set them, you do not have to specify their values when you use the Command-Line Interface (CLI) to configure and start Edge Microgateway.</p>
<h2>Configuring SSL on the Edge Microgateway server</h2>
<p>You can configure the Microgateway server to use SSL. For example, with SSL configured, you can call APIs through Edge Microgateway with the "https" protocol, like this:</p>
<pre>
https://localhost:8000/myapi</pre>
<p>To configure SSL on the Microgateway server, follow these steps:</p>
<ol>
	<li>Generate or obtain an SSL certificate and key using the&nbsp;<a href="https://www.openssl.org">openssl</a>&nbsp;utility or whichever method you prefer.&nbsp;</li>
	<li>Add the&nbsp;<code>edgemicro:ssl</code>&nbsp;attribute to the Edge Microgateway configuration file. For a complete list of options, see the table below. For details on modifying the Edge Microgateway config, see&nbsp;<a href="#Making configuration changes">Making configuration changes</a>. For example:<br />
		<pre>
 edgemicro:
     ssl:
         key: &lt;absolute path to the SSL key file&gt;
         cert: &lt;absolute path to the SSL cert file&gt;
         passphrase: admin123 #option added in v2.2.2
	 rejectUnauthorized: true #option added in v2.2.2
         requestCert: true 
</pre>
		<div class="note">The key specified in the referenced SSL key file&nbsp;<strong>must not be encrypted</strong>.</div>
	</li>
	<li>Restart Edge Microgateway. Follow the steps outlined in&nbsp;<a href="#Making configuration changes">Making configuration changes</a>&nbsp;depending on which configuration file you edited: the default file or the runtime config file.&nbsp;</li>
</ol>
<p>Here's an example of the edgemicro section of the config file, with SSL configured:</p>
<pre>
edgemicro:
  port: 8000
  max_connections: 1000
  max_connections_hard: 5000
  logging:
    level: error
    dir: /var/tmp
    stats_log_interval: 60
    rotate_interval: 24
  plugins:
    sequence:
      - oauth
  ssl:
    key: /MyHome/SSL/em-ssl-keys/server.key
    cert: /MyHome/SSL/em-ssl-keys/server.crt
    passphrase: admin123 #option added in v2.2.2
    rejectUnauthorized: true #option added in v2.2.2
</pre>
<p>Here is a list of all of the supported server options:</p>
<table class="table">
	<tbody>
		<tr>
			<th scope="col" width="124">Option</th>
			<th scope="col" width="676">Description</th>
		</tr>
		<tr>
			<td><code>key</code></td>
			<td>Path to a&nbsp;<code>ca.key</code>&nbsp;file (in PEM format).</td>
		</tr>
		<tr>
			<td><code>cert</code></td>
			<td>Path to a&nbsp;<code>ca.cert</code>&nbsp;file (in PEM format).</td>
		</tr>
		<tr>
			<td><code>pfx</code></td>
			<td>Path to a&nbsp;<code>pfx</code>&nbsp;file containing the private key, certificate, and CA certs of the client in PFX format.</td>
		</tr>
		<tr>
			<td><code>passphrase</code></td>
			<td>A string containing the passphrase for the private key or PFX.</td>
		</tr>
		<tr>
			<td><code>ca</code></td>
			<td>Path to a file containing a list of trusted certificates in PEM format.</td>
		</tr>
		<tr>
			<td><code>ciphers</code></td>
			<td>A string describing the ciphers to use separated by a ":".</td>
		</tr>
		<tr>
			<td><code>rejectUnauthorized</code></td>
			<td>If true, the server certificate is verified against the list of supplied CAs. If verification fails, an error is returned.</td>
		</tr>
		<tr>
			<td><code>secureProtocol</code></td>
			<td>The SSL method to use. For example, SSLv3_method to force SSL to version 3.</td>
		</tr>
		<tr>
			<td><code>servername</code></td>
			<td>The server name for the SNI (Server Name Indication) TLS extension.</td>
		</tr>
		<tr>
			<td><code>requestCert</code></td>
			<td>true for 2-way SSL; false for 1-way SSL</td>
		</tr>
	</tbody>
</table>
<h2>Using client SSL/TLS options</h2>
<p>You can configure Edge Microgateway to be a TLS or SSL client when connecting to target endpoints. In the Microgateway configuration file, use the targets element to set SSL/TLS options.</p>
<p>This example provides settings that will be applied to all hosts:</p>
<pre>
targets:
   ssl:
     client:
       key: /Users/jdoe/nodecellar/twowayssl/ssl/client.key
       cert: /Users/jdoe/nodecellar/twowayssl/ssl/ca.crt
       passphrase: admin123
       rejectUnauthorized: true</pre>
<p>In this example, the settings are applied only to the specified host:</p>
<pre>
targets:
   host: 'myserver.example.com'
   ssl:
     client:
       key: /Users/myname/twowayssl/ssl/client.key
       cert: /Users/myname/twowayssl/ssl/ca.crt
       passphrase: admin123
       rejectUnauthorized: true
</pre>
<p>Here is an example for TLS:</p>
<pre>
targets:
   host: 'myserver.example.com'
   tls:
     client:
       pfx: /Users/myname/twowayssl/ssl/client.pfx
       passphrase: admin123
       rejectUnauthorized: true</pre>
<p>Here is a list of all of the supported client options:</p>
<table class="table">
	<tbody>
		<tr>
			<th scope="col" width="124">Option</th>
			<th scope="col" width="676">Description</th>
		</tr>
		<tr>
			<td><code>pfx</code></td>
			<td>Path to a&nbsp;<code>pfx</code>&nbsp;file containing the private key, certificate, and CA certs of the client in PFX format.</td>
		</tr>
		<tr>
			<td><code>key</code></td>
			<td>Path to a&nbsp;<code>ca.key</code>&nbsp;file (in PEM format).</td>
		</tr>
		<tr>
			<td><code>passphrase</code></td>
			<td>A string containing the passphrase for the private key or PFX.</td>
		</tr>
		<tr>
			<td><code>cert</code></td>
			<td>Path to a&nbsp;<code>ca.cert</code>&nbsp;file (in PEM format).</td>
		</tr>
		<tr>
			<td><code>ca</code></td>
			<td>Path to a file containing a list of trusted certificates in PEM format.</td>
		</tr>
		<tr>
			<td><code>ciphers</code></td>
			<td>A string describing the ciphers to use separated by a ":".</td>
		</tr>
		<tr>
			<td><code>rejectUnauthorized</code></td>
			<td>If true, the server certificate is verified against the list of supplied CAs. If verification fails, an error is returned.</td>
		</tr>
		<tr>
			<td><code>secureProtocol</code></td>
			<td>The SSL method to use. For example, SSLv3_method to force SSL to version 3.</td>
		</tr>
		<tr>
			<td><code>servername</code></td>
			<td>The server name for the SNI (Server Name Indication) TLS extension.</td>
		</tr>
	</tbody>
</table>
<h2>Customizing the edgemicro-auth proxy</h2>
<p>By default, Edge Microgateway uses a proxy deployed on Apigee Edge for OAuth2 authentication. This proxy is deployed when you initially run&nbsp;<code>edgemicro configure</code>. You can change the default configuration of this proxy to add support for custom claims to a JSON Web Token (JWT), configure token expiration, and generate refresh tokens. For details, see the&nbsp;<a href="https://github.com/apigee/microgateway-edgeauth">edgemicro-auth</a>&nbsp;page in GitHub.</p>
<h2>Using a custom auth service</h2>
<p>By default, Edge Microgateway uses a proxy deployed on Apigee Edge for OAuth2 authentication. This proxy is deployed when you initially run&nbsp;<code>edgemicro configure</code>. By default, this proxy's URL is specified in the Edge Microgateway config file as follows:</p>
<pre>
authUri: https://myorg-myenv.apigee.net/edgemicro-auth</pre>
<p>If you want to use your own custom service to handle authentication, change the&nbsp;<code>authUri</code>&nbsp;value in the config file to point to your service. For example, you may have a service that uses LDAP to verify identity.</p>
<div class="note">
	<p><strong>Important</strong>: If you change the auth service URI, you also need to configure these attributes in your Edge Microgateway config file:</p>
	<ul>
		<li><code>edgeconfig:verify_api_key_url</code>&nbsp;- Set this URL to point to the API key endpoint on your custom auth service. In the default edgemicro-auth proxy, this URL is:&nbsp;<code>https://myorg-myenv.apigee.net/edgemicro-auth/publicKey.</code></li>
		<li><code>edgeconfig:products</code>&nbsp;- Set this URL to point to the products endpoint on your custom auth service. In the default edgemicro-auth proxy, this URL is:&nbsp;<code>https://myorg-myenv.apigee.net/edgemicro-auth/products.</code></li>
	</ul>
</div>
<div class="note">
	<p><strong>Important:</strong>&nbsp;If you override the default auth proxy, the new proxy or service must return a response format that is identical to the default&nbsp;<code>edgemicro-auth</code>&nbsp;proxy.</p>
</div>
<h2><a id="Managing log files" name="Managing log files"></a>Managing log files</h2>
<p>Edge Microgateway logs information about each request and response. Log files provide useful information for debugging and troubleshooting.</p>
<div class="note">
	<p>This section describes the built-in log utility for Edge Microgateway. If you need to use a third-party logging module, like Bunyan or Winston, you can write a custom plugin. For details, check out this blog:&nbsp;<a href="http://apigee.com/about/blog/developer/tutorial-adding-logger-plugin-apigee-edge-microgateway">Tutorial: Adding a Logger Plugin to Apigee Edge Microgateway</a>. See also <a href="http://docs.apigee.com/node/22856">http://docs.apigee.com/node/22856</a>.</p>
</div>
<h3><a id="Where log files are stored" name="Where log files are stored"></a>Where log files are stored</h3>
<p>By default, log files are stored in&nbsp;<code>/var/tmp</code>.</p>
<h3><a id="How to change the default log file director" name="How to change the default log file director"></a>How to change the default log file directory</h3>
<p>The directory where log files are stored is specified in the Edge Microgateway configuration file. For details on making configuration changes, see&nbsp;<a href="#Making configuration changes">Making configuration changes</a>.</p>
<pre>
edgemicro:
&nbsp; home: ../gateway
&nbsp; port: 8000
&nbsp; max_connections: -1
&nbsp; max_connections_hard: -1
&nbsp; logging:
&nbsp; &nbsp; level: info
  &nbsp; <strong>dir: /var/tmp
    </strong>stats_log_interval: 60
    rotate_interval: 24
</pre>
<p>Change the&nbsp;<strong>dir</strong>&nbsp;value to specify a different log file directory.</p>
<h3>Send logs to the console</h3>
<p>You can configure logging so that log information is sent to standard output instead of to a log file. Set the&nbsp;<code>to_console</code>&nbsp;flag to true as follows:</p>
<pre>
edgemicro:
  logging:
    to_console: true  
</pre>
<p>With this setting, logs will be sent to standard out. Currently, you cannot send logs to both stdout and to a log file.</p>
<h3>How to set the logging level</h3>
<p>You can set these log levels:&nbsp;<strong>info</strong>,&nbsp;<strong>warn</strong>, and&nbsp;<strong>error</strong>. The info level is recommended. It logs all API requests and responses, and it is the default.</p>
<h3><a id="log-intervals" name="log-intervals"></a>How to change log intervals</h3>
<p>You can configure these intervals in the Edge Microgateway config file. For details on making configuration changes, see&nbsp;<a href="#Making configuration changes">Making configuration changes</a>.</p>
<p>The configurable attributes are:</p>
<ul>
	<li><strong>stats_log_interval</strong>: (default: 60) Interval, in seconds, when the stats record is written to the API log file.</li>
	<li><strong>rotate_interval</strong>: (default: 24) Interval, in hours, when log files are rotated. For example:</li>
</ul>
<pre style="margin-left: 40px;">
edgemicro:
&nbsp; home: ../gateway
&nbsp; port: 8000
&nbsp; max_connections: -1
&nbsp; max_connections_hard: -1
&nbsp; logging:
&nbsp; &nbsp; level: info
  &nbsp; dir: /var/tmp<strong>
    stats_log_interval: 60
    rotate_interval: 24</strong></pre>
<p><strong>Note:&nbsp;</strong>Archived log files are not compressed. When the interval starts, a new log file is created with a new timestamp.&nbsp;</p>
<h3><a id="Good log file maintenance practices" name="Good log file maintenance practices"></a>Good log file maintenance practices</h3>
<p>As log file data accumulates over time, Apigee recommends that you adopt the following practices:</p>
<ul>
	<li>Because log files can become quite large, be sure that the log file directory has sufficient space. See the following sections&nbsp;<a href="#Where log files are stored">Where log files are stored</a>&nbsp;and&nbsp;<a href="#How to change the default log file director">How to change the default log file directory</a>.</li>
	<li>Either delete or move log files to a separate archive directory at least once a week.</li>
	<li>If your policy is to delete logs, you can use the CLI command&nbsp;<code>edgemicro log -c</code>&nbsp;&nbsp;to remove (clean) older logs.</li>
</ul>
<h3>Log file naming convention</h3>
<p>Each Edge Microgateway instance produces three types of log files:</p>
<ul>
	<li><strong>api</strong>&nbsp;- Logs all requests and responses that flow through Edge Microgateway. API counters (stats) and errors are also logged to this file.</li>
	<li><strong>err</strong>&nbsp;- Logs anything sent to stderr.</li>
	<li><strong>out</strong>&nbsp;- Logs anything sent to stdout.</li>
</ul>
<p>This is the naming convention:</p>
<pre>
edgemicro-&lt;Host Name&gt;-&lt;Instance ID&gt;-&lt;Log Type&gt;.log</pre>
<p>For example:</p>
<pre>
edgemicro-mymachine-local-MTQzNTgNDMxODAyMQ-api.log
edgemicro-mymachine-local-MTQzNTg1NDMODAyMQ-err.log
edgemicro-mymachine-local-mtqzntgndmxodaymq-out.log
</pre>
<h3>About log file contents</h3>
<p><em>Added in: v2.3.3</em></p>
<p>By default, the logging service omits the JSON of downloaded proxies, products, and the JSON Web Token (JWT). If you wish to output these objects to the log files, set the&nbsp;<code>DEBUG=*</code>&nbsp;when you start Edge Microgateway. For example:</p>
<p><code>DEBUG=* edgemicro start -o docs -e test -k abc123 -s xyz456</code></p>
<p><strong>Note:&nbsp;</strong>On Windows, use&nbsp;<code>SET DEBUG=*</code></p>
<h3>Contents of the "api" log file</h3>
<p>The "api" log file contains detailed information about the flow of requests and responses through Edge Microgateway. The "api" log files are named like this:</p>
<pre>
edgemicro-mymachine-local-MTQzNjIxOTk0NzY0Nw-api.log</pre>
<p>For each request made to Edge Microgateway, four events are captured in the "api" log file:</p>
<ul>
	<li>Incoming request from the client</li>
	<li>Outgoing request made to the target</li>
	<li>Incoming response from the target</li>
	<li>Outgoing response to the client</li>
</ul>
<p>Each of these separate entries is represented in a shorthand notation to help make the log files more compact. Here are four sample entries representing each of the four events. In the log file, they look like this (the line numbers are only for reference in the doc, they don't appear in the log file).</p>
<pre>
(1) 1436403888651 info req m=GET, u=/, h=localhost:8000, r=::1:59715, i=0
(2) 1436403888665 info treq m=GET, u=/, h=127.0.0.18080, i=0
(3) 1436403888672 info tres s=200, d=7, i=0
(4) 1436403888676 info res s=200, d=11, i=0
</pre>
<p>Let's look at them one by one:</p>
<h4>1. Sample of incoming request from client:</h4>
<pre>
1436403888651 info req m=GET, u=/, h=localhost:8000, r=::1:59715, i=0</pre>
<ul>
	<li><strong>1436403888651</strong>&nbsp;- Unix date stamp</li>
	<li><strong>info</strong>&nbsp;- Depends on the context. Can be info, warn,&nbsp;or error, depending on the log level. Can be stats&nbsp;for a stats record, warn for warnings, or error&nbsp;for errors.</li>
	<li><strong>req</strong>&nbsp;- Identifies the event. In this case, request from the client.</li>
	<li><strong>m</strong>&nbsp;- The HTTP verb used in the request.</li>
	<li><strong>u</strong>&nbsp;- The part of the URL following the basepath.</li>
	<li><strong>h</strong>&nbsp;- The host and port number where Edge Microgateway is listening.</li>
	<li><strong>r</strong>&nbsp;- The remote host and port where the client request originated.</li>
	<li><strong>i</strong>&nbsp;- The request ID. All four event entries will share this ID. Each request is assigned a unique request ID. Correlating log records by request ID can give valuable insight into the target’s latency.</li>
	<li><strong>d</strong>&nbsp;- The duration in milliseconds since the request was received by Edge Microgateway. In the example above, the target’s response for request 0 was received after 7 milliseconds (line 3), and the response was sent to the client after an additional 4 milliseconds (line 4). In other words, the total request latency was 11 milliseconds, out of which 7 milliseconds were taken by the target and 4 milliseconds by Edge Microgateway itself.</li>
</ul>
<h4>2. Sample of outgoing request made to the target:</h4>
<pre>
1436403888665 info treq m=GET, u=/, h=127.0.0.1:8080, i=0
</pre>
<ul>
	<li><strong>1436403888651</strong>&nbsp;- Unix date stamp</li>
	<li><strong>info</strong>&nbsp;- Depends on the context. Can be info, warn,&nbsp;or error, depending on the log level. Can be stats&nbsp;for a stats record, warn for warnings, or error&nbsp;for errors.</li>
	<li><strong>treq</strong>&nbsp;- Identifies the event. In this case, target request. &nbsp;</li>
	<li><strong>m</strong>&nbsp;- The HTTP verb used in the target request.</li>
	<li><strong>u</strong>&nbsp;- The part of the URL following the basepath.</li>
	<li><strong>h</strong>&nbsp;- The host and port number of the backend target.</li>
	<li><strong>i</strong>&nbsp;- The ID of the log entry. All four event entries will share this ID.</li>
</ul>
<p><strong>3. Sample of incoming response from the target</strong></p>
<pre>
1436403888672 info tres s=200, d=7, i=0</pre>
<p><strong>1436403888651</strong>&nbsp;- Unix date stamp</p>
<ul>
	<li><strong>info</strong>&nbsp;- Depends on the context. Can be info, warn,&nbsp;or error, depending on the log level. Can be stats&nbsp;for a stats record, warn for warnings, or error&nbsp;for errors.</li>
	<li><strong>tres</strong>&nbsp;- Identifies the event. In this case, target response.</li>
	<li><strong>s</strong>&nbsp;- The HTTP response status.</li>
	<li><strong>d</strong>&nbsp;- The duration in milliseconds. The time taken for the API call by the target.</li>
	<li><strong>i</strong>&nbsp;- The ID of the log entry. All four event entries will share this ID.</li>
</ul>
<p><strong>4. Sample of outgoing response to the client</strong></p>
<pre>
1436403888676 info res s=200, d=11, i=0
</pre>
<p><strong>1436403888651</strong>&nbsp;- Unix date stamp</p>
<ul>
	<li><strong>info</strong>&nbsp;- Depends on the context. Can be info, warn,&nbsp;or error, depending on the log level. Can be stats&nbsp;for a stats record, warn for warnings, or error&nbsp;for errors.</li>
	<li><strong>res</strong>&nbsp;- Identifies the event. In this case, response to the client.</li>
	<li><strong>s</strong>&nbsp;- The HTTP response status.</li>
	<li><strong>d</strong>&nbsp;- The duration in milliseconds. &nbsp;This is the total time taken by the API call, including the time taken by the target API and the time take by Edge Microgateway itself.</li>
	<li><strong>i</strong>&nbsp;- The ID of the log entry. All four event entries will share this ID.</li>
</ul>
<h3>Log file schedule</h3>
<p>Log files are rotated on the interval specified by the&nbsp;<strong>rotate_interval</strong>&nbsp;<a href="#log-intervals">configuration attribute</a>. Entries will continue being added to the same log file until the rotation interval expires. However, each time Edge Microgateway is restarted it receives a new UID and creates a new set of log files with this UID. See also&nbsp;<a href="#Good log file maintenance practices">Good log file maintenance practices</a>.</p>
<h2><a id="Edge Microgateway configuration reference" name="Edge Microgateway configuration reference"></a>Edge Microgateway&nbsp;configuration reference</h2>
<h3>Location of the configuration file</h3>
<p>The configurations attributes described in this section are located in the Edge Microgateway configuration file. For details on making configuration changes, see&nbsp;<a href="#Making configuration changes">Making configuration changes</a>.&nbsp;</p>
<div class="note">
	<p>See the <a href="http://docs.apigee.com/node/37651">http://docs.apigee.com/node/37651</a> for more information about how to use this file.</p>
</div>
<h3>edge_config attributes</h3>
<p>These settings are used to configure interaction between the Edge Microgateway instance and Apigee Edge.</p>
<ul>
	<li><strong>bootstrap</strong>: (default: none) A URL that points to an Edge Microgateway-specific service running on Apigee Edge. Edge Microgateway uses this service to communicate with Apigee Edge. This URL is returned when you execute the command to generate the public/private key pair:&nbsp;<strong><code>edgemicro genkeys</code></strong>. See the <a href="http://docs.apigee.com/node/37651">http://docs.apigee.com/node/37651</a>&nbsp;for details.</li>
	<li><strong>jwt_public_key</strong>: (default: none) A URL that points to the Edge Microgateway proxy that is deployed on Apigee Edge. This proxy serves as an authentication endpoint for issuing signed access tokens to clients. This URL is returned when you execute the command to deploy the proxy:&nbsp;<strong>edgemicro configure</strong>. See the <a href="http://docs.apigee.com/node/37651">http://docs.apigee.com/node/37651</a>&nbsp;for details.</li>
</ul>
<h3>edgemicro attributes</h3>
<p>These settings configure the Edge Microgateway process.</p>
<ul>
	<li><strong>port</strong>: (default: 8000) The port number on which the Edge Microgateway process listens.</li>
	<li><strong>max_connections</strong>: (default: -1) Specifies the maximum number of simultaneous incoming connections that Edge Microgateway can receive. If this number is exceeded, the following status is returned:</li>
	<li><strong>max_connections_hard</strong>: (default: -1) The maximum number of simultaneous requests that Edge Microgateway can receive before shutting down the connection. This setting is intended to thwart denial of service attacks. Typically, set it to a number larger than max_connections.</li>
	<li><strong>logging</strong>:
		<ul>
			<li><strong>level</strong>: (default: error)
				<ul>
					<li><strong>info</strong>&nbsp;- Logs all requests and responses that flow through an Edge Microgateway instance.</li>
					<li><strong>warn</strong>&nbsp;- Logs warning messages only.</li>
					<li><strong>error</strong>&nbsp;- Logs error messages only.</li>
				</ul>
			</li>
		</ul>
		<ul>
			<li><strong>dir</strong>:&nbsp;(default: /var/tmp) The directory where log files are stored.</li>
			<li><strong>stats_log_interval</strong>: (default: 60) Interval, in seconds, when the stats record is written to the api log file.</li>
			<li><strong>rotate_interval</strong>: (default: 24) Interval, in hours, when log files are rotated.&nbsp;</li>
		</ul>
	</li>
</ul>
<ul>
	<li><strong>plugins</strong>:&nbsp;Plugins add functionality to Edge Microgateway. For details about developing plugins, see <a href="http://docs.apigee.com/node/22856">http://docs.apigee.com/node/22856</a>.</li>
</ul>
<ul style="margin-left: 40px;">
	<li><strong>dir</strong>: A relative path from ./gateway &nbsp;directory to the ./plugins&nbsp;directory, or an absolute path.</li>
	<li><strong>sequence</strong>: A list of plugin modules to add to your Edge Microgateway instance. The modules will execute in the order they are specified here.</li>
</ul>
<ul>
	<li><strong>debug:&nbsp;</strong>&nbsp;Adds remote debugging to the Edge Microgateway process.
		<ul>
			<li><strong>port</strong>: The port number to listen on. For example, set your IDE debugger to &nbsp;listen on this port.</li>
			<li><strong>args</strong>: Arguments to the debug process. For example:&nbsp;<code>args --nolazy</code><br />
				&nbsp;</li>
		</ul>
	</li>
	<li><strong>config_change_poll_interval:</strong>&nbsp;(default: 600 seconds) Edge Microgateway loads a new configuration periodically and executes a reload if anything changed. The polling picks up any changes made on Edge (changes to products, microgateway-aware proxies, etc) as well as changes made to the local config file.&nbsp;<br />
		&nbsp;</li>
	<li><strong>disabled_config_poll_interval:</strong>&nbsp;(default: false) Set to&nbsp;<strong>true</strong>&nbsp;to&nbsp;<strong>turn off</strong>&nbsp;automatic change polling.&nbsp;</li>
	<li><strong>request_timeout</strong>: Sets a timeout for target requests. The timeout is set in seconds. If a timeout occurs, Edge Microgateway responds with a 504 status code. (Added v2.4.x)</li>
</ul>
<h3>headers attributes</h3>
<p>These settings configure how certain HTTP headers are treated.</p>
<ul>
	<li><strong>x-forwarded-for</strong>: (default: true) Set to false&nbsp;to prevent x-forwarded-for&nbsp;headers to be passed to the target. Note that if an x-forwarded-for header is in the request, its value will be set to the client-ip value in Edge Analytics.</li>
	<li><strong>x-forwarded-host</strong>: (default: true) Set to false&nbsp;to prevent x-forwarded-host&nbsp;headers to be passed to the target.</li>
	<li><strong>x-request-id</strong>: (default: true) Set to false&nbsp;to prevent x-request-id&nbsp;headers to be passed to the target.</li>
	<li><strong>x-response-time</strong>: (default: true) Set to false&nbsp;to prevent x-response-time&nbsp;headers to be passed to the target.</li>
	<li><strong>via</strong>: (default: true) Set to false&nbsp;to prevent via&nbsp;headers to be passed to the target.</li>
</ul>
<h3>oauth attributes</h3>
<p>These settings configure how client authentication is enforced by Edge Microgateway.</p>
<div class="note">
	<p>You can find the steps for obtaining and using access tokens in the <a href="http://docs.apigee.com/node/37651">http://docs.apigee.com/node/37651</a>.</p>
</div>
<ul>
	<li><strong>allowNoAuthorization</strong>: (default: false) If set to true, API calls are allowed to pass through Edge Microgateway without any Authorization header at all. Set this to false&nbsp;to require an Authorization header (default).&nbsp;</li>
	<li><strong>allowInvalidAuthorization</strong>: (default: false) If set to true, API calls are allowed to pass if the token passed in the Authorization header is invalid or expired. Set this to false&nbsp;to require valid tokens (default).</li>
	<li><strong>authorization-header</strong>: (default: Authorization: Bearer) The header used to send the access token to Edge Microgateway. You may wish to change the default in cases where the target needs to use the Authorization header for some other purpose.</li>
	<li><strong>api-key-header</strong>:&nbsp;(default: x-api-key) The name of the header or query parameter used to pass an API key to Edge Microgateway. See also&nbsp;<a href="#usinganapikey">Using an API key</a>.</li>
	<li><strong>keepAuthHeader</strong>: (default: false) If set to true, the Authorization header sent in the request is passed on to the target (it is preserved).&nbsp;</li>
	<li><strong>allowOAuthOnly</strong>&nbsp;-- If set to true, every API must carry an Authorization header with a Bearer Access Token. Allows you to permit only the OAuth security model (while maintaining backward compatibility). (Added 4.2.x)</li>
	<li><strong>allowAPIKeyOnly</strong>&nbsp;-- If set to true, every API must carry an&nbsp;<strong>x-api-key</strong>&nbsp;header (or a custom location) with an API Key.Allows you to permit only the API key security model (while maintaining backward compatibility). (Added 4.2.x)
		<div class="note">Do not set both&nbsp;<strong>allowOAuthOnly</strong>&nbsp;and&nbsp;<strong>allowAPIKeyOnly</strong>&nbsp;to true. The default setting is both flags are set to false (for backward compatibility).</div>
	</li>
</ul>
<h3>Plugin-specific attributes</h3>
<p>See Using plugins for details on configurable attributes for each plugin.</p>
<h2>Filtering proxies</h2>
<p>You can filter which microgateway-aware proxies an Edge Microgateway instance will process. When Edge Microgateway starts, it downloads all of the microgateway-aware proxies in the organization it's associated with. Use the following configuration to limit which proxies the microgateway will process. For example, this configuration limits the proxies the microgateway will process to three:&nbsp;<code>edgemicro_proxy-1</code>,&nbsp;<code>edgemicro_proxy-2</code>, and&nbsp;<code>edgemicro_proxy-3</code>:</p>
<pre>
proxies:
  - edgemicro_proxy-1
  - edgemicro_proxy-2
  - edgemicro_proxy-3</pre>
<h2>Masking analytics data</h2>
<p>The following configuration prevents request path information from showing up in Edge analytics. Add the following to the microgateway configuration to mask the request URI and/or request path. Note that the URI consists of the hostname and path parts of the request.</p>
<pre>
analytics:
  mask_request_uri: 'string_to_mask'
  mask_request_path: 'string_to_mask'</pre>
<h2>Setting up Edge Microgateway behind a company firewall</h2>
<p><em>Supported v4.2.x</em></p>
<p dir="ltr">If Edge Microgateway is installed behind a firewall, the gateway may not be able to communicate with Apigee Edge. In this case, there are two options you can consider:</p>
<p dir="ltr"><strong>Option 1:</strong></p>
<p dir="ltr">The first option is to set the edgemicro: proxy_tunnel option to true in the microgateway config file:</p>
<pre>
edge_config:

  &nbsp;&nbsp;proxy: http://10.224.16.85:3128
&nbsp;&nbsp;  proxy_tunnel: true</pre>
<p dir="ltr">When&nbsp;<strong>proxy_tunnel</strong>&nbsp;is&nbsp;<strong>true</strong>, Edge Microgateway uses the HTTP&nbsp;<strong>CONNECT</strong>&nbsp;method to tunnel HTTP requests over a single TCP connection. (The same is true if the environment variables for configuring the proxy are TLS enabled).</p>
<p dir="ltr"><strong>Option 2:</strong></p>
<p dir="ltr">The second option is to specify a proxy and set proxy_tunnel to false in the microgateway config file. For example:</p>
<pre>
edge_config:
   &nbsp;&nbsp;proxy: http://10.224.16.85:3128
   &nbsp;&nbsp;proxy_tunnel: false</pre>
<p dir="ltr">In this case, you can set the following variables to control the hosts for each HTTP proxy that you wish to use, or which hosts should not handle Edge Microgateway proxies:&nbsp;<strong>HTTP_PROXY</strong>,&nbsp;<strong>HTTPS_PROXY</strong>, and&nbsp;<strong>NO_PROXY</strong>.</p>
<p dir="ltr">You can set&nbsp;<strong>NO_PROXY</strong>&nbsp;as a comma delimited list of domains that Edge Microgateway should not proxy to. For example:</p>
<pre>
export NO_PROXY='localhost,localhost:8080'</pre>
<p dir="ltr">Set&nbsp;<strong>HTTP_PROXY</strong>&nbsp;and&nbsp;<strong>HTTPS_PROXY</strong>&nbsp;to the HTTP proxy endpoint Edge Microgateway can send messages to it. For example:</p>
<pre>
export HTTP_PROXY='http://localhost:3786'

export HTTPS_PROXY='https://localhost:3786'</pre>
<p dir="ltr">For more information on these variables, see:</p>
<p dir="ltr"><a href="https://www.npmjs.com/package/request#controlling-proxy-behaviour-using-environment-variables">https://www.npmjs.com/package/request#controlling-proxy-behaviour-using-environment-variables</a></p>
<br />
<h4>See also</h4>
<p><a href="https://community.apigee.com/questions/15352/how-to-setup-micro-gateway-behind-company-firewall.html">How to set up Edge Microgateway behind a company firewall</a>&nbsp;on the Apigee Community.</p>
<h2>Using wildcards in Microgateway-aware proxies</h2>
<p dir="ltr">You can use one or more "*" wildcards in the base path of an&nbsp;<strong>edgemicro_*</strong>&nbsp;(Microgateway-aware) proxy. For example, a base path of&nbsp;<strong>/team/*/members</strong>&nbsp;allows clients to call&nbsp;<strong>https://[host]/team/blue/members</strong>&nbsp;and&nbsp;<strong>https://[host]/team/green/members</strong>&nbsp;without you needing to create new API proxies to support new teams. Note that&nbsp;<code>/**/</code>&nbsp;is not supported.</p>
<p dir="ltr"><strong>Important:</strong>&nbsp;Apigee does NOT support using a wildcard "*" as the first element of a base path. For example, this is NOT supported:&nbsp;<code>/*/</code>&nbsp;search.</p>
<br />
<h2><a id="debugging" name="debugging"></a>Debugging and Troubleshooting</h2>
<h3>Connecting to a debugger</h3>
<p>You can run Edge Microgateway with a debugger, such as&nbsp;<a href="https://www.npmjs.com/package/node-inspector">node-inspector</a>. This is useful for troubleshooting and debugging custom plugins.&nbsp;</p>
<ol>
	<li>Restart Edge Microgateway in debug mode. To do this, add&nbsp;<code>DEBUG=*</code>&nbsp;to the beginning of the start command. For example:<br />
		<br />
		<code>DEBUG=* edgemicro start -o &nbsp;myorg -e test -k db4e9e8a95aa7fabfdeacbb1169d0a8cbe42bec19c6b98129e02 -s 6e56af7c1b26dfe93dae78a735c8afc9796b077d105ae5618ce7ed</code><br />
		&nbsp;
		<p><strong>Note:</strong>&nbsp;On Windows, use&nbsp;<code>SET DEBUG=*</code></p>
	</li>
	<li>Start your debugger and set it to listen on the port number for the debugging process.</li>
	<li>You can now step through the Edge Microgateway code, set breakpoints, watch expressions, and so on.&nbsp;</li>
</ol>
<p>You can specify standard Node.js flags related to debug mode. For example, &nbsp;<code>--nolazy</code>&nbsp;helps with debugging asynchronous code.&nbsp;</p>
<h3>Checking log files</h3>
<p>If you're having problems, be sure to examine the log files for execution details and error information. For details, see&nbsp;<a href="#Managing log files">Managing log files</a>.</p>
<h2><a id="Using API Key security" name="Using API Key security"></a>Using API Key security</h2>
<p>API keys provide a simple mechanism for authenticating clients making requests to Edge Microgateway. You can obtain an API key by copying the Consumer Key (also called Client ID) value from an Apigee Edge product that includes the Edge Microgateway authentication proxy.</p>
<h3>Caching of keys</h3>
<p>API keys are exchanged for bearer tokens, which are cached. You can disable caching by setting the&nbsp;<code>Cache-Control: no-cache</code>&nbsp;header&nbsp;on incoming requests to Edge Microgateway.</p>
<h3>Using OAuth2 token security</h3>
<p>For details on using an OAuth token with proxy requests, see&nbsp;<a href="https://docs.apigee.com/microgateway/v2.4.x/setting-and-configuring-edge-microgateway-v2.4.x#part4secureedgemicrogateway">Secure Edge Microgateway</a>.&nbsp;</p>
<h3><a id="usinganapikey" name="usinganapikey"></a>Using an API key</h3>
<p>For details on using API keys with proxy requests, see&nbsp;<a href="https://docs.apigee.com/microgateway/v2.4.x/setting-and-configuring-edge-microgateway-v2.4.x#part4secureedgemicrogateway">Secure Edge Microgateway</a>.</p>
<div class="note">
	<p>You can also pass the API key in a query parameter. For example, where&nbsp;<code>[key]</code>&nbsp;is the API key, a string of letters and numbers:</p>
	<pre>
curl "http://localhost:8000/hello?"x-api-key=[key]"
</pre>
</div>
<h3><a id="Configuring the API key name" name="Configuring the API key name"></a>Configuring the API key name</h3>
<p>By default,&nbsp;<code>x-api-key</code>&nbsp;is the name used for the API key header or query parameter. You can change this default in the configuration file, as explained in&nbsp;<a href="#Making configuration changes">Making configuration changes</a>.<code>&nbsp;</code>For example, to change the name to&nbsp;<strong>apiKey</strong>:</p>
<pre>
oauth:
 allowNoAuthorization: false
 allowInvalidAuthorization: false
 api-key-header: apiKey</pre>
