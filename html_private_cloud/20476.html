<h1> Configuring the Router to retry connections to a Message Processor </h1>
<p style="text-align: right;"><em>Edge for Private Cloud v. 4.</em><em>18.01</em></p>
<h2>Configuring the Router response when a Message Processor is unavailable during a health check</h2>
<p>The Router makes a health check to the Message Processor every five seconds to determine if the Message Processor is able to service requests. If a Message Processor goes down, the Router automatically forwards requests to another Message Processor.&nbsp;</p>
<p>You can configure how the Router reacts when the Message Processor goes down by setting the <span style="font-family:courier new,courier,monospace;">conf_load_balancing_load.balancing.driver.nginx.server.retry</span> property on the Router. That property takes a space-delimited set of values that can include:</p>
<ul>
	<li><span style="font-family:courier new,courier,monospace;">off</span>: Disable retry, the Router returns a failure code upon a request.</li>
	<li><span style="font-family:courier new,courier,monospace;">http_599</span>: (Default) If the Router receives an HTTP 599 response from the Message Processor, the Router forwards the request to the next Message Processor.&nbsp;<br />
		<br />
		<span style="font-family:arial,helvetica,sans-serif;">HTTP 599</span> is a special response code that is generated by a Message Processor when it is being shutdown. The Message Processor tries to complete all existing requests, but for any new requests it responds with HTTP 599 to signal to the Router to retry the request on the next Message Processor.&nbsp;</li>
	<li><span style="font-family:courier new,courier,monospace;">error</span>: If an error occurred while establishing a connection with the Message Processor, passing a request to it, or reading the response header from it, the Router forwards the request to the next Message Processor.</li>
	<li><span style="font-family:courier new,courier,monospace;">timeout</span>: If a timeout occurs while establishing a connection with the Message Processor, passing a request to it, or reading the response header from it, the Router forwards the request to the next Message Processor.</li>
	<li><span style="font-family:courier new,courier,monospace;">invalid_header</span>: If the Message Processor returned an empty or invalid response, the Router forwards the request to the next Message Processor.</li>
	<li><span style="font-family:courier new,courier,monospace;">http_XXX</span>: If the Message Processor returned a response with HTTP code <em><strong>XXX</strong></em>, the Router forwards the request to the next Message Processor.</li>
</ul>
<p>To configure the Router:</p>
<ol>
	<li>Edit the<span style="font-family:courier new,courier,monospace;"> /opt/apigee/customer/application/router.properties</span> file (if the file does not exist, create it).</li>
	<li>Add the <span style="font-family:courier new,courier,monospace;">conf_load_balancing_load.balancing.driver.nginx.server.retry</span> property as shown below:<br />
		<span style="font-family:courier new,courier,monospace;">conf_load_balancing_load.balancing.driver.nginx.server.retry=http_599 error</span></li>
	<li>Make sure the properties file is owned by the 'apigee' user:<br />
		<span style="font-family:courier new,courier,monospace;">&gt; chown apigee:apigee /opt/apigee/customer/application/router.properties</span></li>
	<li>Restart the Router:<br />
		<span style="font-family:courier new,courier,monospace;">&gt; /opt/apigee/apigee-service/bin/apigee-service edge-router restart</span></li>
</ol>
<h2>Configuring the Router timeout when accessing Message Processors as part of an&nbsp;API proxy request</h2>
<p>The Edge Router has a preset timeout of 57 seconds when attempting to access a Message Processor as part of handling a request through an API proxy. When that timeout expires, the Router will attempt to connect to another Message Processor, if one is available. Otherwise, it will return an error.</p>
<p>You can use two properties to control this timeout:</p>
<ul>
	<li><span style="font-family:courier new,courier,monospace;">conf_load_balancing_load.balancing.driver.proxy.read.timeout</span>&nbsp;specifies the wait time, in seconds, for a single Message Processor. The default value is 57 seconds.</li>
	<li><span style="font-family:courier new,courier,monospace;">conf_load_balancing_load.balancing.driver.nginx.upstream_next_timeout</span>&nbsp;specifies the total wait time for all Message Processors, in seconds, when your Edge installation has multiple Message Processors. It has a default value of the current value of <span style="font-family:courier new,courier,monospace;">conf_load_balancing_load.balancing.driver.proxy.read.timeout</span>, or 57 seconds.</li>
</ul>
<p>To configure the Router:</p>
<ol>
	<li>Edit the<span style="font-family:courier new,courier,monospace;"> /opt/apigee/customer/application/router.properties</span> file (if the file does not exist, create it).</li>
	<li>Set the properties as shown below:<br />
		<span style="font-family:courier new,courier,monospace;">conf_load_balancing_load.balancing.driver.proxy.read.timeout=120</span><br />
		<span style="font-family:courier new,courier,monospace;">conf_load_balancing_load.balancing.driver.nginx.upstream_next_timeout=240</span></li>
	<li>Make sure the properties file is owned by the 'apigee' user:<br />
		<span style="font-family:courier new,courier,monospace;">&gt; chown apigee:apigee /opt/apigee/customer/application/router.properties</span></li>
	<li>Restart the Router:<br />
		<span style="font-family:courier new,courier,monospace;">&gt; /opt/apigee/apigee-service/bin/apigee-service edge-router restart</span></li>
</ol>
<p>&nbsp;</p>
